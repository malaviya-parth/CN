## Internet Control Message Protocol

- It is best effort delivery system i.e. it neither has Flow control nor error control.
- IP needs support from ICMP for F.C. and E.C.
  - Flow control like if buffer of a router is full it sends error message which indicates server to slow down the sending process.
  - Error Control like if any packet is dropped by router then it informs back the source that it has dropped the packet due to some error.
- ICMP can't detect or correct errors, actually it's an error reporting protocol.
- The error is reported back directly to the source not to any intermediataries.

## Cateogires
- There are 2 categories of messages of ICMP
  - Error Reporting Messages
  - Query Messages

## Error Reporting Messages
- Whenever Datagram is dropped by intermediate router or end receiver then sender must be informed about it's packet has been dropped.
- This information is sent using ICMP.
- Direction of packet movement for ICMP from Router to sender or receiver to sender.

## Some Important Points
- No ICMP error message will be generated in respone to a datagram carrying an ICMP error message.
- No iCMP erro message will be generated for a fragmented datagram that is not the first fragment.
- No ICMP error message will be generated for  datagram having a multicast address.
- No ICMP error message will be generated for a datagram having a special address such as 127.0.0.0 or 0.0.0.0

## ICMP packet
```
  Received Datagram:                           | IP header | 8 bytes | Rest of Data |
  ICMP packet:                   | ICMP header | IP header | 8 bytes |
  Sent Datagram:     | IP header | ICMP header | IP header | 8 bytes |
```
- First 8 bytes of the received datagram along with IP header are there in ICMP packet.
- THis ICMP packet is then wrapped in the IP header and sent back to the sender.

## Types of Error Reporting Messages
1. Destination Unreachable
   1. Destination Host Unreachable
      1. Suppose sender want to send a message to the receiver.
         - There are routers in between, when sent the packet to router.
         - Now, router needs to send to other router but don't know PA, router did ARP query and got the address.
         - Now, this next router has to send it to receiver, router did ARP query but did not get response from the receiver and hence, router has to drop the package, now while dropping this packet it sends the DHU error message to the sender.
      2. Other reason if receiver N/W has smaller MTU then sender N/W and also sender has specified D bit as 1 so, packet cannot be fragmented. In this case router will send DHU error message.
   2. Destination Port Unreachable
      1. At receiver side if corresponding process is absent.
2. Source Quench
   - If buffer is full & datagram arrives at intermediate router or receiver then it will be discarded & source quench message is sent to the sender.
   - It solves 2 purposes
     - It informs the source that datagram has been discarded.
     - It warns the source to slow down.
3. Time Exceeded
    1. Generated by Router
       - When TTL field is 0.
    2. Generated by Destination
       - Fragments of the datagram doesn't arrive in certain time.
4. Parameter Problem
    - Strict Source Route is set and datagram visits any other router.
    - Header Checksum is calculated at each and every intermediate router and error is detected.
5. Redirection:
    - Suppose A wants to send packet to B which can be sent through router R1. 
    - When the machine boots if the every routing table entry is gone except of default router, then A sends packet to a default router say R2.
    - Now, this R2 directs the package to R1 and sends an Redirection error message to A to update it's routing table[where to send B send the packet to router R1].
    - It is different from other error messages because here the packet is not dropped.

## Query Messages
- Query messages always work in pair i.e. request and reply format.

## Types of Query Messages
1. Echo request & Echo reply message:
   - This messages are used to check the communication between sender ans receiver.
   - S & R can be routers or hosts
   - These are designed for diagnostic purposes.
   - If S & R are communicating then it is the proof that intermediate routers are receiving, processing & forwarding datagrams properly.
   - Ping command uses this msg
     - Ex: ping 200.40.50.60
     - It is called Packet Internet Groper
     - It is not a client server application as it works at Network Layer.[GATE 2010]
2. Time stamp Request & Reply:
   - It is used to synchrinize the clocks of S & R.
   - S & R can be in different part of world & hence their time may be different.
   - It is obsolete, nowadays NTP [N/W Time Protocol] is used.
3. Address mask Request & Reply:
   - A host may move it's own IP address but doesn't know it's corresponding net mask. Hence, it can send Address mask request to router & router will send the corresponding netmask.
   - NetMask can be used to find delivery is direct or indirect.
     - First A station get's it's own netmask, then it checks with the IP of the other station by ANDing with netmask if the Net ID of A and other station is same then delivery is direct else indirect.
4. Router Solicitation & Advertising:
   - If host wants to send message to another host on different N/W then it must know address of right router to which packet must be sent.
   - If that router is not working then host must have knowledge about the current status of router.
   - For knowing current status host can broadcast router solicitation message.
   - Routers which receive this msg broadcast their routing information using router advertisement msg.
   - Router can also periodically send routing advertisement msg even if no host has asked.
   - When router broadcast advertisement, it not only announces it's presence but it also gives information about all the routers to which it is aware[Also shares information of it's own routing table]

## Question
A: 130.40.140.60/16, B: 130.40.200.40/18 Which of the following is true?
1. A will think  that B on it's N/W
2. B will think that A on it's N/W
3. both
4. none

### Solution
- A's Netmask: 255.255.0.0
- B's Netmask: 255.255.192.0
- Net IDs by A netmask
  - A: 130.40.0.0
  - B: 130.40.0.0
- Net IDs by B Netmask
  - A: 130.40.128.0
  - B: 130.40.192.0
- Hence, by A's Netmask both got same NetID, so A will think that B on it's N/W.

## Internet Group Message Protocol
- It is iused for the multicasting purpose.